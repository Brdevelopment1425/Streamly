<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Müzik Uygulaması - Tam Özellikli</title>

<!-- FontAwesome ikonlar -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

<style>
  /* ======= Genel ======= */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
    font-family: 'Montserrat', sans-serif;
    user-select: none;
  }
  body {
    background: linear-gradient(135deg, #121212 0%, #1db954 100%);
    color: #fff;
    min-height: 100vh;
    display: flex; flex-direction: column;
    font-size: 16px;
    overflow-x: hidden;
  }

  /* Menü */
  .menu {
    display: flex;
    justify-content: space-around;
    align-items: center;
    background: #181818;
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
    padding: 0.75rem 0;
    position: fixed;
    width: 100%;
    z-index: 9999;
    transition: background-color 0.3s ease;
  }
  .menu.top {
    top: 0;
    border-bottom: 1px solid #282828;
  }
  .menu.bottom {
    bottom: 0;
    border-top: 1px solid #282828;
  }

  .menu button {
    background: none;
    border: none;
    color: #b3b3b3;
    font-size: 1.9rem;
    cursor: pointer;
    padding: 8px 14px;
    border-radius: 14px;
    position: relative;
    transition:
      color 0.3s ease,
      background-color 0.3s ease,
      transform 0.25s ease;
  }
  .menu button[title]:hover::after {
    content: attr(title);
    position: absolute;
    bottom: 120%;
    left: 50%;
    transform: translateX(-50%);
    background: #1db954;
    color: #121212;
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 0.85rem;
    white-space: nowrap;
    pointer-events: none;
    opacity: 1;
    transition: opacity 0.2s ease;
    z-index: 10000;
  }
  .menu button:hover {
    color: #1db954;
    background-color: rgba(29,185,84,0.15);
    transform: scale(1.15);
    box-shadow: 0 0 8px #1db954;
  }
  .menu button.active {
    color: #1db954;
    background-color: rgba(29,185,84,0.25);
    box-shadow: 0 0 12px #1db954;
    transform: scale(1.2);
  }

  main {
    padding: 5rem 2rem 5rem;
    max-width: 900px;
    margin: 0 auto;
    flex-grow: 1;
  }
  .page {
    display: none;
    animation: fadeIn 0.5s ease forwards;
  }
  .page.active {
    display: block;
  }
  @keyframes fadeIn {
    from {opacity: 0;}
    to {opacity: 1;}
  }
  h1 {
    font-weight: 900;
    font-size: 2.7rem;
    text-align: center;
    color: #1db954;
    margin-bottom: 2rem;
    text-shadow: 0 0 8px #1db954;
    letter-spacing: 1.2px;
  }

  /* Filtre inputu ana sayfa */
  #filter-input {
    width: 100%;
    padding: 10px 14px;
    margin-bottom: 1.5rem;
    border-radius: 12px;
    border: none;
    font-size: 1rem;
    box-shadow: inset 0 0 10px #121212;
    background: #212121;
    color: #ddd;
  }

  /* Şarkı listesi grid */
  #popular, #songs-list {
    display: grid;
    grid-template-columns: repeat(auto-fit,minmax(280px,1fr));
    gap: 1.7rem;
  }

  .song-item {
    background: #282828;
    border-radius: 16px;
    padding: 1rem 1.3rem;
    display: flex;
    gap: 1rem;
    cursor: pointer;
    align-items: center;
    transition: box-shadow 0.4s ease, transform 0.3s ease;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  .song-item:hover {
    box-shadow: 0 0 25px #1db954;
    transform: translateY(-5px);
  }

  .song-cover {
    width: 70px;
    height: 70px;
    border-radius: 12px;
    object-fit: cover;
    flex-shrink: 0;
    box-shadow: 0 0 6px rgba(0,0,0,0.6);
  }
  .song-info {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: #ddd;
  }
  .song-name {
    font-weight: 700;
    font-size: 1.2rem;
    color: #1db954;
    margin-bottom: 0.2rem;
    user-select: text;
    text-shadow: 0 0 6px #1db954;
  }
  .song-link {
    font-size: 0.9rem;
    color: #999;
    word-break: break-word;
    user-select: text;
    transition: color 0.3s ease;
  }
  .song-link:hover {
    color: #1db954;
    text-decoration: underline;
  }
  .play-button {
    background: #1db954;
    border: none;
    color: #121212;
    font-size: 1.4rem;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    flex-shrink: 0;
    box-shadow: 0 0 10px #1db954;
    transition: background-color 0.3s ease, transform 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .play-button:hover {
    background-color: #17a84b;
    transform: scale(1.2);
    box-shadow: 0 0 20px #17a84b;
  }

  #toggle-add-form {
    background: #1db954;
    border: none;
    color: #121212;
    padding: 0.85rem 1.3rem;
    border-radius: 30px;
    cursor: pointer;
    margin-bottom: 1.4rem;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 0.6rem;
    font-size: 1.05rem;
    box-shadow: 0 0 10px #1db954;
    transition: background-color 0.3s ease, transform 0.2s ease;
    user-select: none;
    justify-content: center;
  }
  #toggle-add-form:hover {
    background: #17a84b;
    transform: scale(1.05);
  }

  #add-form.hidden {
    display: none;
  }
  #add-form {
    background: #212121;
    padding: 1.3rem 1.7rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: 0 0 25px #121212 inset;
    display: flex;
    flex-direction: column;
    gap: 1.1rem;
    animation: fadeIn 0.3s ease;
  }
  #add-form input {
    font-size: 1rem;
    padding: 0.9rem 1.1rem;
    border-radius: 14px;
    border: none;
    background: #121212;
    color: #ddd;
    box-shadow: inset 0 0 10px #000;
    transition: box-shadow 0.3s ease;
  }
  #add-form input:focus {
    outline: none;
    box-shadow: 0 0 12px #1db954;
  }
  #add-form button[type="submit"] {
    background: #1db954;
    border: none;
    padding: 1rem;
    font-weight: 900;
    color: #121212;
    border-radius: 18px;
    cursor: pointer;
    font-size: 1.1rem;
    box-shadow: 0 0 15px #1db954;
    transition: background-color 0.3s ease, transform 0.25s ease;
  }
  #add-form button[type="submit"]:hover {
    background: #17a84b;
    transform: scale(1.05);
  }

  /* Player sayfası */
  #player {
    text-align: center;
  }
  #player-cover {
    width: 160px;
    height: 160px;
    border-radius: 24px;
    object-fit: cover;
    box-shadow: 0 0 35px #1db954;
    margin-bottom: 1.4rem;
  }
  #player-title {
    font-size: 1.8rem;
    margin-bottom: 1.6rem;
    color: #1db954;
    text-shadow: 0 0 12px #1db954;
    font-weight: 900;
  }
  #player-iframe {
    width: 100%;
    max-width: 480px;
    height: 270px;
    border: none;
    border-radius: 16px;
    box-shadow: 0 0 35px #1db954;
    margin-bottom: 1.8rem;
    background: #000;
  }
  #play-pause {
    font-size: 2.8rem;
    background: #1db954;
    border: none;
    border-radius: 50%;
    width: 64px;
    height: 64px;
    cursor: pointer;
    color: #121212;
    box-shadow: 0 0 25px #1db954;
    transition: background-color 0.3s ease, transform 0.25s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #play-pause:hover {
    background: #17a84b;
    transform: scale(1.1);
  }

  /* Responsive */
  @media (min-width: 768px) {
    main {
      padding: 6rem 3rem 7rem;
    }
    .menu.top {
      display: flex;
    }
    .menu.bottom {
      display: none;
    }
  }
  @media (max-width: 767px) {
    main {
      padding: 2rem 1.3rem 5rem;
    }
    .menu.top {
      display: none;
    }
    .menu.bottom {
      display: flex;
    }
  }
</style>
</head>
<body>

<!-- Menü PC üst çubuk -->
<nav class="menu top" role="navigation" aria-label="Ana Menü">
  <button id="btn-home" title="Ana Sayfa"><i class="fas fa-house"></i></button>
  <button id="btn-list" title="Şarkılar Listesi"><i class="fas fa-list"></i></button>
  <button id="btn-add" title="Şarkı Ekle"><i class="fas fa-plus-circle"></i></button>
  <button id="btn-fav" title="Favoriler"><i class="fas fa-star"></i></button>
</nav>
<!-- Menü Mobil alt çubuk -->
<nav class="menu bottom" role="navigation" aria-label="Ana Menü Mobil">
  <button id="btn-home-m" title="Ana Sayfa"><i class="fas fa-house"></i></button>
  <button id="btn-list-m" title="Şarkılar Listesi"><i class="fas fa-list"></i></button>
  <button id="btn-add-m" title="Şarkı Ekle"><i class="fas fa-plus-circle"></i></button>
  <button id="btn-fav-m" title="Favoriler"><i class="fas fa-star"></i></button>
</nav>

<main>
  <!-- Ana Sayfa -->
  <section id="home" class="page active" role="main" aria-label="Ana Sayfa">
    <h1>En Çok Dinlenenler</h1>

    <input
      type="search"
      id="filter-input"
      placeholder="Şarkı adına göre filtrele..."
      aria-label="Şarkı adına göre filtrele"
      autocomplete="off"
    />

    <div id="popular" aria-live="polite"></div>
  </section>

  <!-- Şarkılar Listesi -->
  <section id="list" class="page" role="main" aria-label="Şarkılar Listesi">
    <button id="toggle-add-form" aria-expanded="false" aria-controls="add-form" title="Yeni Şarkı Ekle">
      <i class="fas fa-plus-circle"></i> Şarkı Ekle
    </button>

    <form id="add-form" class="hidden" aria-hidden="true" aria-label="Şarkı Ekleme Formu">
      <input id="song-name" name="song-name" type="text" placeholder="Şarkı Adı" required autocomplete="off" />
      <input id="song-link" name="song-link" type="url" placeholder="Spotify/YouTube/SoundCloud Linki" required autocomplete="off" />
      <input id="song-cover" name="song-cover" type="url" placeholder="Albüm Kapağı URL" autocomplete="off" />
      <button type="submit" aria-label="Şarkıyı Ekle">Ekle</button>
    </form>

    <div id="songs-list" aria-live="polite"></div>
  </section>

  <!-- Favoriler -->
  <section id="favorites" class="page" role="main" aria-label="Favori Şarkılar">
    <h1>Favori Şarkılarım</h1>
    <div id="fav-list" aria-live="polite" style="min-height:100px; color:#bbb; text-align:center;">
      Favori listeniz boş.
    </div>
  </section>

  <!-- Player -->
  <section id="player" class="page" role="main" aria-label="Çalan Şarkı">
    <img id="player-cover" src="https://via.placeholder.com/160?text=..." alt="Albüm Kapağı" />
    <h2 id="player-title" aria-live="polite" aria-atomic="true">Şarkı Adı</h2>
    <iframe
      id="player-iframe"
      src=""
      allow="autoplay"
      allowfullscreen
      sandbox="allow-scripts allow-same-origin"
      title="Müzik çalar"
      ></iframe>
    <button id="play-pause" title="Oynat / Duraklat" aria-label="Oynat veya duraklat">
      <i class="fas fa-play"></i>
    </button>
  </section>
</main>

<script>
  // ======= Elementler =======
  const pages = {
    home: document.getElementById('home'),
    list: document.getElementById('list'),
    player: document.getElementById('player'),
    favorites: document.getElementById('favorites')
  };
  const navButtons = {
    home: [document.getElementById('btn-home'), document.getElementById('btn-home-m')],
    list: [document.getElementById('btn-list'), document.getElementById('btn-list-m')],
    add: [document.getElementById('btn-add'), document.getElementById('btn-add-m')],
    fav: [document.getElementById('btn-fav'), document.getElementById('btn-fav-m')],
  };
  const toggleAddBtn = document.getElementById('toggle-add-form');
  const addForm = document.getElementById('add-form');
  const songsList = document.getElementById('songs-list');
  const popularDiv = document.getElementById('popular');
  const filterInput = document.getElementById('filter-input');
  const favList = document.getElementById('fav-list');
  const playerCover = document.getElementById('player-cover');
  const playerTitle = document.getElementById('player-title');
  const playPauseBtn = document.getElementById('play-pause');
  const playerIframe = document.getElementById('player-iframe');

  // ======= Durum =======
  let currentPage = 'home';
  let currentSong = null;
  let isPlaying = false;
  let allSongs = [];
  let popularSongs = [];
  let favorites = JSON.parse(localStorage.getItem('favorites')||'[]');

  // ======= Fonksiyonlar =======
  function escapeHtml(text) {
    return text.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // Sayfa geçişi
  function switchPage(page) {
    currentPage = page;
    Object.values(pages).forEach(p => p.classList.remove('active'));
    pages[page].classList.add('active');

    Object.values(navButtons).forEach(buttons => buttons.forEach(btn => btn.classList.remove('active')));
    if(navButtons[page]) navButtons[page].forEach(btn => btn.classList.add('active'));

    if(page !== 'list'){
      addForm.classList.add('hidden');
      toggleAddBtn.setAttribute('aria-expanded', 'false');
    }
    if(page === 'favorites') renderFavorites();
  }

  // Menü butonları event
  Object.values(navButtons).forEach(buttons => {
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        if(btn.id.includes('home')) switchPage('home');
        else if(btn.id.includes('list')) switchPage('list');
        else if(btn.id.includes('add')) {
          switchPage('list');
          addForm.classList.remove('hidden');
          toggleAddBtn.setAttribute('aria-expanded', 'true');
        }
        else if(btn.id.includes('fav')) switchPage('favorites');
      });
    });
  });

  // Şarkı ekleme form toggle
  toggleAddBtn.addEventListener('click', () => {
    if(addForm.classList.contains('hidden')){
      addForm.classList.remove('hidden');
      toggleAddBtn.setAttribute('aria-expanded', 'true');
    } else {
      addForm.classList.add('hidden');
      toggleAddBtn.setAttribute('aria-expanded', 'false');
    }
  });

  // Link doğrulama
  function validateLink(url) {
    try {
      const u = new URL(url);
      const allowed = ['open.spotify.com', 'music.youtube.com', 'youtube.com', 'youtu.be', 'soundcloud.com'];
      return allowed.some(domain => u.hostname.includes(domain));
    } catch {
      return false;
    }
  }

  // Şarkı ekleme API çağrısı
  addForm.addEventListener('submit', async e => {
    e.preventDefault();
    const name = document.getElementById('song-name').value.trim();
    const link = document.getElementById('song-link').value.trim();
    const cover = document.getElementById('song-cover').value.trim();

    if(!validateLink(link)){
      alert('Sadece Spotify, YouTube, SoundCloud linkleri kabul edilir.');
      return;
    }

    try {
      const res = await fetch('/api/songs', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name, file: link, cover}),
      });
      if(!res.ok) throw new Error('Sunucu hatası');
      addForm.reset();
      addForm.classList.add('hidden');
      toggleAddBtn.setAttribute('aria-expanded', 'false');
      await loadSongs();
      switchPage('list');
    } catch(e){
      alert('Hata oluştu, tekrar deneyin.');
      console.error(e);
    }
  });

  // Şarkıları yükle
  async function loadSongs(){
    try {
      const res = await fetch('/api/songs');
      if(!res.ok) throw new Error('API hatası');
      const songs = await res.json();

      allSongs = songs;
      popularSongs = [...songs].sort((a,b) => (b.count||0)-(a.count||0)).slice(0,5);

      renderPopular(popularSongs);
      renderSongsList(allSongs);
    } catch(e){
      popularDiv.innerHTML = '<p>Şarkılar yüklenirken hata oluştu.</p>';
      songsList.innerHTML = '<p>Şarkılar yüklenirken hata oluştu.</p>';
      console.error(e);
    }
  }

  // Popüler şarkıları renderla
  function renderPopular(songs){
    if(!songs.length){
      popularDiv.innerHTML = '<p>Henüz şarkı yok.</p>';
      return;
    }
    popularDiv.innerHTML = songs.map(s => `
      <div class="song-item" tabindex="0" role="button" aria-label="Şarkı: ${escapeHtml(s.name)}" data-id="${s.id}">
        <img src="${s.cover || 'https://via.placeholder.com/70?text=?'}" alt="Albüm kapağı" class="song-cover" />
        <div class="song-info">
          <div class="song-name">${escapeHtml(s.name)}</div>
          <a href="${s.file}" target="_blank" class="song-link">${escapeHtml(s.file)}</a>
        </div>
        <button class="play-button" title="Oynat" aria-label="Şarkıyı oynat"><i class="fas fa-play"></i></button>
        <button class="fav-button" title="Favorilere Ekle" aria-label="Favorilere Ekle"><i class="fas fa-star"></i></button>
      </div>
    `).join('');

    attachSongEvents(popularDiv, songs);
  }

  // Şarkı listesi renderla
  function renderSongsList(songs){
    if(!songs.length){
      songsList.innerHTML = '<p>Henüz şarkı yok.</p>';
      return;
    }
    songsList.innerHTML = songs.map(s => `
      <div class="song-item" tabindex="0" role="button" aria-label="Şarkı: ${escapeHtml(s.name)}" data-id="${s.id}">
        <img src="${s.cover || 'https://via.placeholder.com/70?text=?'}" alt="Albüm kapağı" class="song-cover" />
        <div class="song-info">
          <div class="song-name">${escapeHtml(s.name)}</div>
          <a href="${s.file}" target="_blank" class="song-link">${escapeHtml(s.file)}</a>
        </div>
        <button class="play-button" title="Oynat" aria-label="Şarkıyı oynat"><i class="fas fa-play"></i></button>
        <button class="fav-button" title="Favorilere Ekle" aria-label="Favorilere Ekle"><i class="fas fa-star"></i></button>
      </div>
    `).join('');

    attachSongEvents(songsList, songs);
  }

  // Favorileri renderla
  function renderFavorites(){
    if(!favorites.length){
      favList.innerHTML = 'Favori listeniz boş.';
      return;
    }
    favList.innerHTML = favorites.map(s => `
      <div class="song-item" tabindex="0" role="button" aria-label="Favori Şarkı: ${escapeHtml(s.name)}" data-id="${s.id}">
        <img src="${s.cover || 'https://via.placeholder.com/70?text=?'}" alt="Albüm kapağı" class="song-cover" />
        <div class="song-info">
          <div class="song-name">${escapeHtml(s.name)}</div>
          <a href="${s.file}" target="_blank" class="song-link">${escapeHtml(s.file)}</a>
        </div>
        <button class="play-button" title="Oynat" aria-label="Şarkıyı oynat"><i class="fas fa-play"></i></button>
        <button class="fav-button remove" title="Favorilerden Kaldır" aria-label="Favorilerden Kaldır"><i class="fas fa-star"></i></button>
      </div>
    `).join('');

    attachSongEvents(favList, favorites, true);
  }

  // Olayları ata: play + fav ekle/kaldır
  function attachSongEvents(container, songsArray, isFavSection = false){
    container.querySelectorAll('.play-button').forEach(btn => {
      btn.onclick = e => {
        e.stopPropagation();
        const id = btn.closest('.song-item').dataset.id;
        playSong(id, songsArray);
        switchPage('player');
      };
    });
    container.querySelectorAll('.song-item').forEach(item => {
      item.onclick = () => {
        const id = item.dataset.id;
        playSong(id, songsArray);
        switchPage('player');
      };
    });
    container.querySelectorAll('.fav-button').forEach(btn => {
      btn.onclick = e => {
        e.stopPropagation();
        const id = btn.closest('.song-item').dataset.id;
        if(isFavSection){
          removeFromFavorites(id);
        } else {
          addToFavorites(id, songsArray);
        }
      };
    });
  }

  // Favorilere ekle
  function addToFavorites(id, songsArray){
    const song = songsArray.find(s => s.id === id);
    if(!song) return;
    if(favorites.some(f => f.id === id)){
      alert('Zaten favorilerde.');
      return;
    }
    favorites.push(song);
    localStorage.setItem('favorites', JSON.stringify(favorites));
    alert('Favorilere eklendi.');
  }

  // Favorilerden çıkar
  function removeFromFavorites(id){
    favorites = favorites.filter(f => f.id !== id);
    localStorage.setItem('favorites', JSON.stringify(favorites));
    renderFavorites();
  }

  // Şarkı çalma
  function playSong(id, songsArray){
    const song = songsArray.find(s => s.id === id);
    if(!song) return;
    currentSong = song;
    playerCover.src = song.cover || 'https://via.placeholder.com/160?text=...';
    playerTitle.textContent = song.name;

    // Embed URL oluştur
    const embedUrl = getEmbedUrl(song.file);
    if(!embedUrl){
      alert('Geçerli bir Spotify, YouTube veya SoundCloud linki değil.');
      return;
    }

    playerIframe.src = embedUrl;
    isPlaying = true;
    updatePlayPauseIcon();
  }

  // Embed URL dönüştürme
  function getEmbedUrl(url){
    try {
      const u = new URL(url);

      // Spotify
      if(u.hostname.includes('spotify.com')){
        // Open.spotify.com URL'sini embed linke çevir
        const path = u.pathname;
        if(path.startsWith('/track/') || path.startsWith('/album/') || path.startsWith('/playlist/')){
          return `https://open.spotify.com/embed${path}`;
        }
      }
      // YouTube
      else if(u.hostname.includes('youtube.com') || u.hostname.includes('youtu.be')){
        let videoId = '';
        if(u.hostname === 'youtu.be'){
          videoId = u.pathname.slice(1);
        } else {
          videoId = u.searchParams.get('v') || '';
        }
        if(videoId) return `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0`;
      }
      // SoundCloud
      else if(u.hostname.includes('soundcloud.com')){
        return `https://w.soundcloud.com/player/?url=${encodeURIComponent(url)}&auto_play=true`;
      }
      return null;
    } catch {
      return null;
    }
  }

  // Play/pause toggle
  playPauseBtn.addEventListener('click', () => {
    // iframe kontrolü sınırlı, bu yüzden sayfayı reload etmek veya mute/unmute gerekebilir.
    if(isPlaying){
      playerIframe.contentWindow.postMessage('{"method":"pause"}', '*');
      isPlaying = false;
    } else {
      playerIframe.contentWindow.postMessage('{"method":"play"}', '*');
      isPlaying = true;
    }
    updatePlayPauseIcon();
  });

  // Play/pause buton güncelle
  function updatePlayPauseIcon(){
    if(isPlaying){
      playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
    } else {
      playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
    }
  }

  // Klavye space = oynat/durdur (player sayfasındayken)
  window.addEventListener('keydown', e => {
    if(currentPage !== 'player') return;
    if(e.code === 'Space'){
      e.preventDefault();
      playPauseBtn.click();
    }
  });

  // Ana sayfa filtreleme
  filterInput.addEventListener('input', () => {
    const val = filterInput.value.trim().toLowerCase();
    if(!val){
      renderPopular(popularSongs);
      return;
    }
    const filtered = popularSongs.filter(s => s.name.toLowerCase().includes(val));
    renderPopular(filtered);
  });

  // Sayfa yüklendiğinde
  window.onload = async () => {
    await loadSongs();
  };
</script>

</body>
</html>
